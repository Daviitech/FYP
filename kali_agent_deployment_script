#!/bin/bash
# kali_agent_deploy.sh
# Automated deployment script for Zabbix Agent on Kali Linux
# Part of the Network Monitoring Project

# Exit on any error
set -e

# Color formatting for better readability
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Banner
echo -e "${BLUE}"
echo "====================================================="
echo " Zabbix Agent Deployment for Kali Linux               "
echo " Network Monitoring Project                          "
echo "====================================================="
echo -e "${NC}"

# Default Zabbix server IP
DEFAULT_SERVER_IP="192.168.1.10"
SERVER_IP=$DEFAULT_SERVER_IP

# Check if custom server IP provided
if [ ! -z "$1" ]; then
    SERVER_IP="$1"
fi

# Get hostname
HOST_NAME=$(hostname)

echo -e "${YELLOW}Starting Zabbix agent installation for${NC} ${GREEN}$HOST_NAME${NC}"
echo -e "${YELLOW}Agent will connect to Zabbix server at:${NC} ${GREEN}$SERVER_IP${NC}"

# Check for root privileges
if [ "$(id -u)" != "0" ]; then
   echo -e "${RED}This script must be run as root${NC}" 
   exit 1
fi

# Confirm before proceeding
echo -e "${YELLOW}This script will install Zabbix Agent on your Kali Linux system.${NC}"
read -p "Do you want to continue? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}Installation aborted.${NC}"
    exit 1
fi

echo -e "\n${BLUE}[1/7]${NC} ${YELLOW}Adding Zabbix repository...${NC}"
# Add Zabbix repository
wget -q https://repo.zabbix.com/zabbix/6.0/debian/pool/main/z/zabbix-release/zabbix-release_6.0-4+debian11_all.deb -O /tmp/zabbix-release.deb
dpkg -i /tmp/zabbix-release.deb
apt update

echo -e "\n${BLUE}[2/7]${NC} ${YELLOW}Installing Zabbix agent...${NC}"
# Install agent
apt install -y zabbix-agent

echo -e "\n${BLUE}[3/7]${NC} ${YELLOW}Configuring agent...${NC}"
# Backup original configuration
cp /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak

# Configure agent
cat > /etc/zabbix/zabbix_agentd.conf <<EOF
# Zabbix Agent Configuration for Kali Linux
# Generated by deployment script

PidFile=/var/run/zabbix/zabbix_agentd.pid
LogFile=/var/log/zabbix/zabbix_agentd.log
LogFileSize=0
Server=$SERVER_IP
ServerActive=$SERVER_IP
Hostname=$HOST_NAME
Include=/etc/zabbix/zabbix_agentd.d/*.conf

# Security configuration
TLSConnect=psk
TLSAccept=psk
TLSPSKIdentity=PSK 001
TLSPSKFile=/etc/zabbix/zabbix_agentd.psk

# Enable remote commands
EnableRemoteCommands=1
LogRemoteCommands=1

# Kali-specific settings
# Allow monitoring of hacking tools and pentesting utilities
UnsafeUserParameters=1

# Additional Kali-specific user parameters
UserParameter=kali.tools.nmap[*],nmap $1 2>&1 | grep "open" | wc -l
UserParameter=kali.tools.metasploit.status,systemctl is-active metasploit.service || echo "inactive"
EOF

echo -e "\n${BLUE}[4/7]${NC} ${YELLOW}Setting up secure communications...${NC}"
# Generate random PSK key
openssl rand -hex 32 > /etc/zabbix/zabbix_agentd.psk
chmod 600 /etc/zabbix/zabbix_agentd.psk

# Store PSK key for reference (securely)
PSK_KEY=$(cat /etc/zabbix/zabbix_agentd.psk)
echo -e "${GREEN}Generated PSK key:${NC} $PSK_KEY"
echo -e "${YELLOW}Store this key securely - you'll need it to configure the server.${NC}"

echo -e "\n${BLUE}[5/7]${NC} ${YELLOW}Adding custom security tools monitoring...${NC}"
# Create directory for custom scripts if it doesn't exist
mkdir -p /etc/zabbix/scripts
chmod 755 /etc/zabbix/scripts

# Create a script to monitor security tool statuses
cat > /etc/zabbix/scripts/security_tools.sh <<EOF
#!/bin/bash
case "\$1" in
    "nmap")
        if which nmap > /dev/null; then echo "1"; else echo "0"; fi
        ;;
    "metasploit")
        if which msfconsole > /dev/null; then echo "1"; else echo "0"; fi
        ;;
    "burpsuite")
        if which burpsuite > /dev/null; then echo "1"; else echo "0"; fi
        ;;
    "wireshark")
        if which wireshark > /dev/null; then echo "1"; else echo "0"; fi
        ;;
    "hydra")
        if which hydra > /dev/null; then echo "1"; else echo "0"; fi
        ;;
    *)
        echo "ZBX_NOTSUPPORTED"
        ;;
esac
EOF

chmod 755 /etc/zabbix/scripts/security_tools.sh

# Add user parameter for security tools
cat > /etc/zabbix/zabbix_agentd.d/security_tools.conf <<EOF
UserParameter=kali.tools[*],/etc/zabbix/scripts/security_tools.sh \$1
EOF

echo -e "\n${BLUE}[6/7]${NC} ${YELLOW}Configuring firewall...${NC}"
# Configure firewall if ufw is enabled
if command -v ufw > /dev/null && ufw status | grep -q "active"; then
    ufw allow 10050/tcp
    echo -e "${GREEN}UFW rule added for Zabbix agent${NC}"
fi

echo -e "\n${BLUE}[7/7]${NC} ${YELLOW}Starting Zabbix agent service...${NC}"
# Restart and enable agent
systemctl restart zabbix-agent
systemctl enable zabbix-agent

# Check if agent is running
if systemctl is-active --quiet zabbix-agent; then
    echo -e "\n${GREEN}✓ Zabbix agent installation completed successfully!${NC}"
    echo -e "${GREEN}✓ Service is running properly${NC}"
else
    echo -e "\n${RED}⚠ Zabbix agent installation completed but service is not running.${NC}"
    echo -e "${YELLOW}Check logs with:${NC} journalctl -u zabbix-agent"
fi

# Print summary
echo -e "\n${BLUE}=== Installation Summary ===${NC}"
echo -e "${YELLOW}Hostname:${NC} $HOST_NAME"
echo -e "${YELLOW}Server:${NC} $SERVER_IP"
echo -e "${YELLOW}PSK Identity:${NC} PSK 001"
echo -e "${YELLOW}PSK File:${NC} /etc/zabbix/zabbix_agentd.psk"
echo -e "${YELLOW}Status:${NC} $(systemctl is-active zabbix-agent)"
echo -e "${YELLOW}Log File:${NC} /var/log/zabbix/zabbix_agentd.log"

echo -e "\n${BLUE}=== Next Steps ===${NC}"
echo -e "1. Add this host in Zabbix server web interface"
echo -e "2. Configure with PSK encryption using the key above"
echo -e "3. Apply the 'Template OS Linux' template"
echo -e "4. Create a custom template for Kali-specific security tools"

exit 0
